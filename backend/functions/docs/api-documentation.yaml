openapi: 3.0.0
info:
  title: KAI-SAAS Agent Management API
  description: |
    API para gestión de agentes de IA y autenticación de usuarios en el panel de administración.
    
    ## Autenticación
    Las APIs de autenticación utilizan Firebase Auth con tokens JWT Bearer.
    
    **Flujo:**
    1. Login → Obtener token JWT
    2. Usar token en header `Authorization: Bearer <token>` para APIs protegidas
    3. Token expira en 1 hora
    
    ## Base URL
    `https://us-central1-asistente-comercial-8d43c.cloudfunctions.net`
    
    ## Seguridad
    - APIs protegidas requieren token JWT válido
    - Validación de que el agente pertenezca al usuario
    - Modo test disponible con `userId=testid` para desarrollo
    
  version: 2.0.0
  contact:
    name: API Support
    email: desgarcia2112@gmail.com

servers:
  - url: https://us-central1-asistente-comercial-8d43c.cloudfunctions.net
    description: Production server

tags:
  - name: Authentication
    description: Operaciones de autenticación y gestión de usuarios
  - name: Agents
    description: Operaciones relacionadas con agentes
  - name: Collections
    description: Operaciones sobre colecciones de agentes

paths:
  # ============================================================================
  # AUTHENTICATION APIS
  # ============================================================================
  
  /login:
    post:
      tags:
        - Authentication
      summary: Login de usuario
      description: |
        Autentica un usuario con email y password.
        Retorna un token JWT que debe usarse en las demás APIs protegidas.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: Email del usuario
                password:
                  type: string
                  format: password
                  description: Contraseña del usuario
              required:
                - email
                - password
            example:
              email: usuario@example.com
              password: password123
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Login successful
                      user:
                        $ref: '#/components/schemas/User'
                      token:
                        type: string
                        description: JWT token para autenticación
                        example: eyJhbGciOiJSUzI1NiIsImtpZCI6Ij...
                      refreshToken:
                        type: string
                        description: Token para refrescar el JWT
                      expiresIn:
                        type: string
                        description: Tiempo de expiración en segundos
                        example: "3600"
                  timestamp:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /getUserProfile:
    get:
      tags:
        - Authentication
      summary: Obtener perfil del usuario autenticado
      description: Retorna el perfil completo del usuario autenticado
      operationId: getUserProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    allOf:
                      - $ref: '#/components/schemas/User'
                      - type: object
                        properties:
                          createdAt:
                            type: string
                            format: date-time
                          lastSignIn:
                            type: string
                            format: date-time
                  timestamp:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /updatePassword:
    post:
      tags:
        - Authentication
      summary: Actualizar contraseña
      description: Cambia la contraseña del usuario autenticado
      operationId: updatePassword
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  description: Nueva contraseña (mínimo 6 caracteres)
              required:
                - newPassword
            example:
              newPassword: nuevaPassword123
      responses:
        '200':
          description: Contraseña actualizada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Password updated successfully
                      uid:
                        type: string
                  timestamp:
                    type: string
                    format: date-time
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /updateEmail:
    post:
      tags:
        - Authentication
      summary: Actualizar email
      description: |
        Cambia el email del usuario autenticado.
        El nuevo email se marca como no verificado.
      operationId: updateEmail
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newEmail:
                  type: string
                  format: email
                  description: Nuevo email
              required:
                - newEmail
            example:
              newEmail: nuevo@email.com
      responses:
        '200':
          description: Email actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Email updated successfully. Please verify your new email.
                      uid:
                        type: string
                      newEmail:
                        type: string
                        format: email
                      emailVerified:
                        type: boolean
                        example: false
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Email inválido o ya en uso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                emailInUse:
                  summary: Email ya en uso
                  value:
                    success: false
                    error:
                      message: Email already in use
                      code: 400
                invalidFormat:
                  summary: Formato inválido
                  value:
                    success: false
                    error:
                      message: Validation failed
                      code: 400
                      validationErrors:
                        - field: newEmail
                          message: Invalid email format
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /updateProfile:
    put:
      tags:
        - Authentication
      summary: Actualizar perfil de usuario
      description: |
        Actualiza datos del perfil del usuario (nombre, foto, teléfono).
        NO actualiza email ni password (usar APIs específicas).
      operationId: updateProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayName:
                  type: string
                  description: Nombre del usuario
                photoURL:
                  type: string
                  format: uri
                  description: URL de la foto de perfil
                phoneNumber:
                  type: string
                  description: Número de teléfono
              example:
                displayName: Juan Pérez
                photoURL: https://example.com/photo.jpg
                phoneNumber: "+1234567890"
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    allOf:
                      - $ref: '#/components/schemas/User'
                      - type: object
                        properties:
                          updatedAt:
                            type: string
                            format: date-time
                  timestamp:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # AGENT MANAGEMENT APIS
  # ============================================================================
  

  /getAgentsByUserId:
    get:
      tags:
        - Agents
      summary: Obtener todos los agentes de un usuario
      description: |
        Retorna todos los agentes asociados a un usuario desde la colección `usersBuilders/{userId}/agentDrafts`.
        Cada agente incluye todos sus campos en formato JSON.
      operationId: getAgentsByUserId
      parameters:
        - name: userId
          in: query
          required: true
          description: ID del usuario propietario de los agentes
          schema:
            type: string
          example: q5ia05np1XNIGQr6KaigStsb0Fs1
      responses:
        '200':
          description: Lista de agentes obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: q5ia05np1XNIGQr6KaigStsb0Fs1
                      agents:
                        type: array
                        items:
                          $ref: '#/components/schemas/Agent'
                      total:
                        type: integer
                        example: 3
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /getAgentById:
    get:
      tags:
        - Agents
      summary: Obtener un agente por ID
      description: |
        Obtiene un agente específico de la colección `agent_configurations` con todos sus campos
        y los nombres de todas sus subcolecciones dinámicamente.
      operationId: getAgentById
      parameters:
        - name: id
          in: query
          required: true
          description: ID del agente
          schema:
            type: string
          example: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
      responses:
        '200':
          description: Agente obtenido exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Agent'
                      - type: object
                        properties:
                          collections:
                            type: array
                            description: Nombres de las subcolecciones del agente
                            items:
                              type: string
                            example: ["chats", "knowledgeBase", "modifications", "properties", "sheets", "tools", "users"]
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /getCollectionByAgentId:
    get:
      tags:
        - Collections
      summary: Obtener documentos de una colección específica de un agente
      description: |
        Obtiene todos los documentos de una colección específica de un agente.
        Incluye validación de seguridad para verificar que el agente pertenece al usuario.
        
        **Modo Test:** Usa `userId=testid` para saltarse la validación de seguridad durante desarrollo.
        
        **Ruta en Firestore:** `agent_configurations/{agentId}/{collectionName}`
      operationId: getCollectionByAgentId
      parameters:
        - name: userId
          in: query
          required: true
          description: ID del usuario (para validación de seguridad). Usa "testid" para modo test.
          schema:
            type: string
          example: q5ia05np1XNIGQr6KaigStsb0Fs1
        - name: agentId
          in: query
          required: true
          description: ID del agente
          schema:
            type: string
          example: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
        - name: collectionName
          in: query
          required: true
          description: Nombre de la colección a consultar
          schema:
            type: string
            enum:
              - chats
              - knowledgeBase
              - modifications
              - properties
              - sheets
              - tools
              - users
          example: knowledgeBase
      responses:
        '200':
          description: Documentos de la colección obtenidos exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        example: q5ia05np1XNIGQr6KaigStsb0Fs1
                      agentId:
                        type: string
                        example: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
                      collectionName:
                        type: string
                        example: knowledgeBase
                      documents:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              description: ID del documento
                          additionalProperties: true
                      total:
                        type: integer
                        example: 5
                      path:
                        type: string
                        example: agent_configurations/3b01d3b2-742e-4d80-85ff-8613eae9abc6/knowledgeBase
              examples:
                withDocuments:
                  summary: Colección con documentos
                  value:
                    success: true
                    data:
                      userId: q5ia05np1XNIGQr6KaigStsb0Fs1
                      agentId: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
                      collectionName: knowledgeBase
                      documents:
                        - id: doc1
                          title: "Información del producto"
                          content: "Detalles sobre el producto..."
                        - id: doc2
                          title: "Preguntas frecuentes"
                          content: "FAQ del servicio..."
                      total: 2
                      path: agent_configurations/3b01d3b2-742e-4d80-85ff-8613eae9abc6/knowledgeBase
                emptyCollection:
                  summary: Colección vacía
                  value:
                    success: true
                    data:
                      userId: q5ia05np1XNIGQr6KaigStsb0Fs1
                      agentId: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
                      collectionName: chats
                      documents: []
                      total: 0
                      message: La colección "chats" no tiene documentos
                      availableCollections: ["knowledgeBase", "tools", "users"]
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Acceso denegado - El agente no pertenece al usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Access denied: Agent does not belong to this user"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /updateAgent:
    post:
      tags:
        - Agents
      summary: Actualizar un agente
      description: Actualiza los campos de un agente existente
      operationId: updateAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                agentId:
                  type: string
                  description: ID del agente a actualizar
                updates:
                  type: object
                  description: Campos a actualizar
                  additionalProperties: true
              required:
                - agentId
                - updates
      responses:
        '200':
          description: Agente actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Agent updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenido del endpoint /login
  
  schemas:
    User:
      type: object
      properties:
        uid:
          type: string
          description: ID único del usuario
          example: abc123xyz...
        email:
          type: string
          format: email
          description: Email del usuario
          example: usuario@example.com
        displayName:
          type: string
          description: Nombre del usuario
          example: Juan Pérez
        photoURL:
          type: string
          format: uri
          description: URL de la foto de perfil
        phoneNumber:
          type: string
          description: Número de teléfono
        emailVerified:
          type: boolean
          description: Si el email está verificado
          example: true
    
    Agent:
      type: object
      properties:
        id:
          type: string
          description: ID único del agente
          example: 3b01d3b2-742e-4d80-85ff-8613eae9abc6
        name:
          type: string
          description: Nombre del agente
          example: "Agente de Ventas"
        description:
          type: string
          description: Descripción del agente
        status:
          type: string
          description: Estado del agente
          enum: [active, inactive, draft]
          example: active
        createdAt:
          type: string
          format: date-time
          description: Fecha de creación
        updatedAt:
          type: string
          format: date-time
          description: Última actualización
      additionalProperties: true
    
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            message:
              type: string
            code:
              type: integer
        timestamp:
          type: string
          format: date-time

  responses:
    Unauthorized:
      description: No autorizado - Token inválido, expirado o no proporcionado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            noToken:
              summary: Token no proporcionado
              value:
                success: false
                error:
                  message: No authorization token provided
                  code: 401
                timestamp: "2025-12-04T16:00:00.000Z"
            invalidToken:
              summary: Token inválido
              value:
                success: false
                error:
                  message: Invalid token format
                  code: 401
                timestamp: "2025-12-04T16:00:00.000Z"
            expiredToken:
              summary: Token expirado
              value:
                success: false
                error:
                  message: Token expired
                  code: 401
                timestamp: "2025-12-04T16:00:00.000Z"
    
    ValidationError:
      description: Error de validación
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: object
                properties:
                  message:
                    type: string
                    example: Validation failed
                  code:
                    type: integer
                    example: 400
                  validationErrors:
                    type: array
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                        message:
                          type: string
              timestamp:
                type: string
                format: date-time
    
    BadRequest:
      description: Petición inválida - Parámetros faltantes o incorrectos
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "User ID is required"
    
    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Agent not found"
    
    InternalError:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Failed to get agents"
              details:
                type: string
                description: Detalles técnicos del error
